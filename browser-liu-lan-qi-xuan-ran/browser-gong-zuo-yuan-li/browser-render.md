# browser - 渲染

上一章阐述了浏览器的架构，在最新的多进程架构中，最重要的是**渲染进程**，因为浏览器内核（渲染引擎）和JavaScript引擎（blink）都运行在该进程中。

那么以一道经典的问题来开启浏览器的渲染，**浏览器中输入URL到页面展示，到底发生了什么？**

![&#x8F93;&#x5165;URL&#x5230;&#x9875;&#x9762;&#x5C55;&#x793A;&#x5B8C;&#x6574;&#x6D41;&#x7A0B;&#x56FE;](../../.gitbook/assets/url_load.png)

浏览器多进程架构中，浏览器进程负责用户交互、处理输入信息，管理子进程等。这里UI线程是浏览器进程中的线程，是处理用户输入的。接下来逐一分析每一个过程。

### 页面加载

页面加载分为以下一个过程：

* 处理输入
* 请求URL
* 准备渲染进程
* 提交文档
* 渲染阶段

#### 处理输入

当在浏览器地址栏输入内容后，点击搜索或者回车，UI 线程会判断这个内容是不是URL。

如果是**搜索词**，则搜索对应的内容，合成新的URL。

如果是**URL**，则完善整个请求的URL，包括协议等。

在请求到的新页面替换当前页面之前，当前页面会执行一次 beforeUnload事件，清除当前页面的数据。或者询问用户是否需要离开当前页面，如果拒绝离开当前，浏览器则不会进行后续的操作。如果同意离开，就进入了请求URL的过程。

### URL请求过程

此时浏览器进程跟网络进程进行**进程之间通信（IPC）**，将URL请求发送到网络进程，在网络进程中开始了真正的请求。这个就是Client和Server进行网络的交互的过程，也是HTTP请求的过程。有以下几个步骤：

* 查找是否有HTTP缓存
* DNS解析
* 建立TCP连接，如果是HTTPS，建立TLS连接
* 发起HTTP请求
* 接收响应头，响应体

这个过程在HTTP不好玩中再细细阐述。

#### 重定向

当接收到响应头中的状态码为 `301` 或者 `302`  ，说明服务器需要浏览器重定向到其他地址，该地址在响应头中`Location` ，然后重新发起新的HTTP、HTTPS请求。

如果状态码为 `200` ，则说明可以继续处理后面的流程。首先处理的是响应体数据，浏览器根据响应头的`Content-type` 来判断是继续渲染页面还是下载文件或者其他。

#### 处理响应数据类型

浏览器根据`Content-Type` 的类型处理不同的数据。

如果是`Content-Type` 的类型为下载类型，则浏览器将该请求交给下载管理器，同时导航过程结束。

如果是`Content-Type: text/html` 的类型，则说明是HTML文件，继续导航过程。

### 准备渲染进程

该过程就是在开始渲染页面之前，提前准备好渲染进程，以便后续渲染流程顺利进行。

我们知道，打开一个页面，浏览器会为这个页面分配一个渲染进程。但是也有**多个页面共用一个渲染进程**的情况，这个就跟”**同一站点“**有关系了

**同一站点** **根域名**加上**协议**，包括根域名下的所有子域名和端口。

```http
https://wangbaoqi.com
https://www.wangbaoqi.com
```

类似上面地址，这两个地址是同一站点，所以共用一个渲染进程。

### 提交导航

渲染进程准备好之后，浏览器进程向渲染进程提交网络进程接收到的响应体（HTML数据）。

* 浏览器进程接收到网络进程的响应头，就开始向渲染进程发起提交文档的消息
* 渲染进程接收到消息之后，就和网络进程建立消息传输的管道
* 等数据传输完成之后，渲染进程就会返回**确认导航**的消息给浏览器进程
* 浏览器进程收到确认导航的消息之后，会更新浏览器界面状态，包含了安全状态，前进后退状态以及地址栏URL，并且更新web页面

这也就是为什么打开一个页面会有一个加载的过程，到此为止，导航过程就结束了，接下来到了渲染过程，也就是最重要的一个环节，这个也是浏览器内核所做的事情。

### 渲染阶段

渲染阶段就就会开始页面解析以及子资源加载，一旦页面生成，就会向浏览器进程发送消息，浏览器进程接收到消息之后，就会停止加载动画。接下来详细阐述下这个过程。。

当网络进程将URL请求的响应通过消息管道传输到渲染进程之后，渲染进程就会开始解析响应数据（也就是HTML文件\)。

```markup
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    />
    <link rel="apple-touch-icon" href="/logo192.png" />
    
    <link rel="manifest" href="/manifest.json" />
    
    <title>React App</title>
  </head>
  <body>
    <div id="root"></div>
    
    <script src="/static/js/bundle.js"></script>
    <script src="/static/js/vendors~main.chunk.js"></script>
    <script src="/static/js/main.chunk.js"></script>
  </body>
</html>
```

上述的HTML文件就是发布到正式环境之后的文件。

渲染进程要通过以下几个过程才能得到最后的图像，每个过程都会有**输入的内容**，**处理过程**以及**输出结果。**

* 构建DOM
* 样式计算
* 布局阶段
* 分层
* 绘制
* 分块
* 光栅化
* 合成

### 渲染阶段 - DOM 树

DOM树是浏览器能够理解的数据结构，因此需要将HTML解析成DOM树（其实是数据结构中的 **树** ）。

![](../../.gitbook/assets/image%20%2814%29.png)

DOM树的形式是**JavaScript对象**，因此可以用JS来修改节点的属性。

DOM树是由**HTML 解析器**将HTML解析完成的。在[「HTML - 解析HTML文档」](../../html/parse-html.md)会详细说到如何将HTML解析成DOM树的。

### 渲染阶段 - 样式计算

样式计算就是计算出DOM树中每个节点的样式。

首先，将纯文本CSS转换成浏览器能够理解的格式 - **styleSheets。**这些纯文本CSS引入方式有**外部引入Link、style 内联**以及**style属性内嵌。**

![](../../.gitbook/assets/image%20%2813%29.png)







